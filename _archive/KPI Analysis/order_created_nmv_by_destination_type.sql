SET @extractstart = '2016-10-01';
SET @extractend = '2016-11-01';

SET @free = '183,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,971,972,973,974,975,976,977,978,979,980,981,1732,1736,1832,1833,1834,1835,1836,1837,1838,1839,1840,1841,1842,1843,1844,1845,2061,2062,2063,2064,2065,2066,2068,2069,2070,2071,2072,3697,3730,3731,3732,3733,3734,3735,3736,3737,3738,3739,3740,3741,3742,3940,3941,3942,3943,3944,3945,3951,3952,3953,3954,3955,4442,4444,4445,4446,4448,4449,4450,4451,4452,4453,4454,4455,4456,4457,4458,4459,4460,4462,4463,4464,4465,4466,4467,4468,4469,4470,4471,4472,4473,4474,4475,4476,4477,4478,4480,4481,4483,4484,4485,4486,4487,4488,4489,4490,4491,4492,4493,4494,4495,4544,4545,4546,4547,4548,4549,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,4560,4561,4563,4564,4565,4566,4567,4569,4570,4571,4572,4573,4574,4575,4576,4590,4598,4625,4626,4627,4629,4630,4631,4633,4634,4635,4636,4637,4638,4639,4641,4642,4643,4644,4645,4646,4647,4648,4650,4651,4652,4653,4654,4655,4656,4657,4658,4659,4660,4661,4662,4697,4698,4699,4700,4701,4702,4703,4704,4705,4706,4707,4708,4709,4710,4711,4712,4713,4714,4715,4716,4718,4719,4720,4721,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4734,4735,4796,4799,4810,4811,4828,4829,4830,4831,4832,4833,4834,4835,4836,4837,4838,4839,4840,4841,4842,4843,4844,4845,4846,4847,4848,4849,4850,4851,4852,4853,4854,4856,4857,4858,4859,4860,4861,4862,4863,4864,4865,4866,4867,4868,4869,4870,4871,4872,4873,4874,4875,4876,4877,4878,4879,4880,4881,4883,4884,4885,4886,4888,4889,4890,4891,4892,4893,4894,4895,4896,4897,4898,4899,4900,4901,4902,4903,4909,4918,4925,4937,4938,4939,4940,4941,4942,4943,4944,4945,4946,4947,4948,4949,4950,4951,4952,4953,4954,4980,4981,4982,4983,4984,4985,4988,4989,4990,4991,4992,4993,4994,4995,4996,4997,4998,4999,5000,5001,5002,5003,5004,5005,5006,5057,5058,5059,5060,5061,5062,5063,5064,5065,5066,5067,5068,5069,5070,5071,5072,5073,5075,5076,5077,5078,5079,5080,5081,5082,5083,5084,5085,5086,5087,5088,5089,5090,5091,5092,5093,5094,5095,5096,5097,5098,5099,5100,5101,5102,5103,5104,5105,5107,5108,5109,5111,5112,5113,5115,5116,5118,5119,5120,5121,5122,5124,5125,5126,5128,5129,5130,5256,5257,5258,5259,5260,5261,5262,5263,5264,5265,5266,5267,5268,5269,5270,5271,5272,5273,5274,5362,5363,5364,5365,5366,5367,5368,5369,5370,5371,5372,5373,5374,5375,5376,5377,5378,5379,5380,5381,5382,5416,5417,5418,5419,5420,5421,5422,5423,5424,5425,5426,5427,5428,5429,5430,5431,5432,5433,5434,5435,5436,5437,5438,5439,5440,5441,5657,5658,5659,5660,5661,5662,5663,5664,5665,5666,5667,5668,5669,5670,5671,5672,5673,5674,5675,5676,5677,5678,5679,5680,5681,5682,5683,5711,5712,5713,5714,5715,5717,5718,5719,5720,5721,5722,5723,5724,5725,5726,5727,5728,5729,5730,5731,5732,5748,5749,5750,5751,5752,5753,5754,5755,5756,5757,5758,5759,5760,5761,5762,5763,5764,5765,5766,5767,5768,5769,5770,5771,5772,5773,5774,5775,5776,5777,5778,5779,5780,5781,5782,5783,5784,5785,5786,5815,5816,5817,5818,5819,5820,5821,5822,5823,5824,5825,5826,5827,5828,5829,5830,5831,5832,5833,5834,5835,5836,5837,5838,5839,5840,5841,5842,5843,5844,5845,5846,5847,5848,5849,5850,5851,5852,5853,5854,5855,5856,5857,5858,5859,5860,5861,5972,5973,5974,5975,5976,5977,5978,5979,5980,5981,5982,5983,5984,5985,5986,5987,5988,5989,5990,5991,5992,5993,5994,5995,5996,5997,5998,5999,6000,6001,6003,6004,6005,6006,6007,6008,6009,6010,6011,6012,6013,6014,6015,6016,6017,6018,6019,6020,6021,6022,6023,6024,6025,6026,6027,6028,6029,6030,6031,6032,6033,6078,6079,6080,6081,6082,6083,6084,6085,6086,6087,6088,6089,6090,6091,6092,6093,6094,6095,6096,6097,6098,6099,6100,6101,6102,6103,6104,6105,6106,6107,6108,6109,6110,6111,6112,6113,6114,6115,6116,6117,6190,6191,6192,6193,6194,6195,6196,6197,6198,6199,6200,6201,6202,6203,6204,6205,6206,6207,6208,6209,6210,6211,6212,6213,6214,6215,6216,6217,6218,6219,6220,6221,6222,6223,6224,6225,6226,6227,6228,6229,6231,6232,6233,6234,6235,6236,6237,6238,6239,6240,6241,6242,6243,6244,6245,6246,6247,6248,6249,6250,6251,6252,6253,6255,6256,6257,6258,6259,6260,6261,6262,6263,6264,6265,6266,6267,6268,6269,6271,6272,6273,6274,6275,6276,6277,6278,6279,6280,6281,6282,6283,6284,6285,6286,6287,6288,6289,6290,6291,6292,6293,6294,6295,6296,6297,6298,6299,6300,6301,6303,6304,6305,6306,6307,6308,6309,6310,6311,6312,6314,6315,6316,6317,6318,6319,6320,6322,6323,6324,6325,6326,6327,6329,6330,6331,6332,6333,6335,6336,6337,6339,6340,6341,6342,6343,6344,6346,6347,6348,6349,6350,6351,6352,6353,6354,6355,6356,6357,6364,6365,6366,6367,6368,6369,6370,6371,6372,6373,6374,6375,6376,6377,6378,6379,6380,6381,6382,6383,6384,6385,6386,6387,6388,6389,6390,6391,6392,6393,6605,6606,6608,6609,6610,6611,6612,6613,6615,6616,6617,6618,6619,6620,6621,6622,6623,6624,6626,6627,6628,6629,6630,6631,6632,6633,6634,6635,6637,6638,6639,6640,6641,6642,6643,6644,6646,6647,6648,6649,6650,6651,6652,6653,6655,6656,6657,6658,6659,6660,6661,6662,6663,6664,6665,6666,6667,6668,6669,6670,6671,6673,6674,6675,6676,6677,6678,6679,6680,6681,6682,6683,6684,6686,6687,6688,6689,6690,6691,6692,6693,6694,6695,6696,6697,6698,6699,6700,6701,6702,6703,6705,6706,6707,6708,6709,6710,6711,6712,6713,6714,6715,6716,6717,6718,6719,6720,6721,6723,6724,6725,6726,6727,6728,6729,6730,6731,6732,6733,6734,6735,6736,6857,6858,6859,6860,6861,6862,6863,6864,6865,6866,6867,6868,6869,6870,6871,6872,6873,6874,6875,6876,6877,6878,6879,6880,6881,6882,6883,6884,6885,6887,6888,6889,6890,6891,6892,6893,6894,6895,6896,6897,6898,6899,6900,6901,6902,6903,6904,6905,6906,6907,6908,6909,6910,6911,6912,6913,6914,6916,6917,6918,6919,6920,6921,6922,6923,6924,6925,6926,6927,6928,6929,6930,6931,6932,6933,6934,6935,6936,6937,6938,6939,6940,6941,6942,6943,6944,6945,6946,6947,6948,6949,6950,6952,6953,6954,6955,6956,6957,6958,6959,6960,6961,6962,6963,6964,6965,6966,6967,6968,6969,6970,6971,6972,6973,6974,6975,6976,6977,6978,6979,6981,6982,6983,6984,6985,6986,6987,6989,6990,6991,6992,6993,6994,6995,6996,6997,6998,6999,7000,7001,7003,7004,7005,7006,7007,7008,7010,7011,7012,7013,7014,7015,7016,7017,7060,7061,7062,7063,7064,7097,7120,7121,7122,7123,7124,7125,7127,7128,7129,7130,17211,17212,17229,17231,17232,17235,17236,17237,17238,17240,17241,17242,17244,17245,17246,17247,17248,17249,17259,17315,17316,17317,17318,17319,17347,17353,17370,17375,17376,17379,17380,17381,17382,17383,17384,17385,17386,17387,17388,17389,17390,17391,17392,17393,17394,17443,17480,17483,17493,17494,17496,17501,17502,17505,17506,17629';
SET @old_free = '183,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,971,972,973,974,975,976,977,978,979,980,981,1732,1736,1832,1833,1834,1835,1836,1837,1838,1839,1840,1841,1842,1843,1844,1845,2061,2062,2063,2064,2065,2066,2068,2069,2070,2071,2072,3697,3730,3731,3732,3733,3734,3735,3736,3737,3738,3739,3740,3741,3742,3940,3941,3942,3943,3944,3945,3951,3952,3953,3954,3955,4544,4545,4546,4547,4548,4549,4550,4551,4552,4553,4554,4555,4556,4557,4558,4559,4560,4561,4590,4598,4718,4719,4720,4721,4722,4723,4724,4725,4726,4727,4728,4729,4730,4731,4732,4733,4734,4735,4810,4811,4909,4918,4925,5075,5076,5077,5078,5079,5080,5081,5082,5083,5084,5085,5086,5087,5088,5089,5090,5091,5092,5093,5094,5095,5096,5097,5098,5099,5100,5101,5102,5103,5104,5105,5107,5108,5109,5111,5112,5113,5115,5116,5118,5119,5120,5121,5122,5124,5125,5126,5128,5129,5130,5711,5712,5713,5714,5715,5717,5718,5719,5720,5721,5722,5723,5724,5725,5726,5727,5728,5729,5730,5731,5732,5748,5749,5750,5751,5752,5753,5754,5755,5756,5757,5758,5759,5760,5761,5762,5763,5764,5765,5766,5767,5768,5769,5770,5771,5772,5773,5774,5775,5776,5777,5778,5779,5780,5781,5782,5783,5784,5785,5786,6190,6191,6192,6193,6194,6195,6196,6197,6198,6199,6200,6201,6202,6203,6204,6205,6206,6207,6208,6209,6210,6211,6212,6213,6214,6215,6216,6217,6218,6219,6220,6221,6222,6223,6224,6225,6226,6227,6228,6229,6231,6232,6233,6234,6235,6236,6237,6238,6239,6240,6241,6242,6243,6244,6245,6246,6247,6248,6249,6250,6251,6252,6253,6255,6256,6257,6258,6259,6260,6261,6262,6263,6264,6265,6266,6267,6268,6269,6271,6272,6273,6274,6275,6276,6277,6278,6279,6280,6281,6282,6283,6284,6285,6286,6287,6288,6289,6290,6291,6292,6293,6294,6295,6296,6297,6298,6299,6300,6301,6303,6304,6305,6306,6307,6308,6309,6310,6311,6312,6314,6315,6316,6317,6318,6319,6320,6322,6323,6324,6325,6326,6327,6329,6330,6331,6332,6333,6339,6340,6341,6342,6343,6344,6346,6347,6348,6349,6350,6351,6352,6353,6354,6355,6356,6357,6364,6365,6366,6367,6368,6369,6370,6371,6372,6373,6374,6375,6376,6377,6378,6379,6380,6381,6382,6383,6384,6385,6386,6387,6388,6389,6390,6391,6392,6393,6605,6606,6608,6609,6610,6611,6612,6613,6615,6616,6617,6618,6619,6620,6621,6622,6623,6624,6626,6627,6628,6629,6630,6631,6632,6633,6634,6635,6637,6638,6639,6640,6641,6642,6643,6644,6646,6647,6648,6649,6650,6651,6652,6653,6655,6656,6657,6658,6659,6660,6661,6662,6663,6664,6665,6666,6667,6668,6669,6670,6671,6673,6674,6675,6676,6677,6678,6679,6680,6681,6682,6683,6684,6686,6687,6688,6689,6690,6691,6692,6693,6694,6695,6696,6697,6698,6699,6700,6701,6702,6703,6705,6706,6707,6708,6709,6710,6711,6712,6713,6714,6715,6716,6717,6718,6719,6720,6721,6723,6724,6725,6726,6727,6728,6729,6730,6731,6732,6733,6734,6735,6736,6857,6858,6859,6860,6861,6862,6863,6864,6865,6866,6867,6868,6869,6870,6871,6872,6873,6874,6875,6876,6877,6878,6879,6880,6881,6882,6883,6884,6885,6887,6888,6889,6890,6891,6892,6893,6894,6895,6896,6897,6898,6899,6900,6901,6902,6903,6904,6905,6906,6907,6908,6909,6910,6911,6912,6913,6914,6916,6917,6918,6919,6920,6921,6922,6923,6924,6925,6926,6927,6928,6929,6930,6931,6932,6933,6934,6935,6936,6937,6938,6939,6940,6941,6942,6943,6944,6945,6946,6947,6948,6949,6950,6952,6953,6954,6955,6956,6957,6958,6959,6960,6961,6962,6963,6964,6965,6966,6967,6968,6969,6970,6971,6972,6973,6974,6975,6976,6977,6978,6979,6981,6982,6983,6984,6985,6986,6987,6989,6990,6991,6992,6993,6994,6995,6996,6997,6998,6999,7000,7001,7003,7004,7005,7006,7007,7008,7010,7011,7012,7013,7014,7015,7016,7017,7097,7127,7128,7129,7130,17211,17212,17229,17231,17235,17240,17242,17245,17246,17247,17248,17249,17259,17347,17370,17381,17382,17383,17384,17385,17386,17387,17389,17390,17391,17392,17393,17394,17443,17480,17483,17505,17506,17629';
SET @new_free = '5362,5363,5364,5365,5366,5367,5368,5369,5370,5371,5372,5373,5374,5375,5376,5377,5378,5379,5380,5381,5382,5416,5417,5418,5419,5420,5421,5422,5423,5424,5425,5426,5427,5428,5429,5430,5431,5432,5433,5434,5435,5436,5437,5438,5439,5440,5441,5657,5658,5659,5660,5661,5662,5663,5664,5665,5666,5667,5668,5669,5670,5671,5672,5673,5674,5675,5676,5677,5678,5679,5680,5681,5682,5683,5815,5816,5817,5818,5819,5820,5821,5822,5823,5824,5825,5826,5827,5828,5829,5830,5831,5832,5833,5834,5835,5836,5837,5838,5839,5840,5841,5842,5843,5844,5845,5846,5847,5848,5849,5850,5851,5852,5853,5854,5855,5856,5857,5858,5859,5860,5861,5972,5973,5974,5975,5976,5977,5978,5979,5980,5981,5982,5983,5984,5985,5986,5987,5988,5989,5990,5991,5992,5993,5994,5995,5996,5997,5998,5999,6000,6001,6003,6004,6005,6006,6007,6008,6009,6010,6011,6012,6013,6014,6015,6016,6017,6018,6019,6020,6021,6022,6023,6024,6025,6026,6027,6028,6029,6030,6031,6032,6033,6078,6079,6080,6081,6082,6083,6084,6085,6086,6087,6088,6089,6090,6091,6092,6093,6094,6095,6096,6097,6098,6099,6100,6101,6102,6103,6104,6105,6106,6107,6108,6109,6110,6111,6112,6113,6114,6115,6116,6117,6335,6336,6337,7060,7061,7062,7063,7064,17353,17375,17376,17379,17380,17388,17494,17496,17501,17502';
SET @old_mixed = '4442,4444,4445,4446,4448,4449,4450,4451,4452,4453,4454,4455,4456,4457,4458,4459,4460,4462,4463,4464,4465,4466,4467,4468,4469,4470,4471,4472,4473,4474,4475,4476,4477,4478,4480,4481,4483,4484,4485,4486,4487,4488,4489,4490,4491,4492,4493,4494,4495,4563,4564,4565,4566,4567,4569,4570,4571,4572,4573,4574,4575,4576,4625,4626,4627,4629,4630,4631,4633,4634,4635,4636,4637,4638,4639,4641,4642,4643,4644,4645,4646,4647,4648,4650,4651,4652,4653,4654,4655,4656,4657,4658,4659,4660,4661,4662,4697,4698,4699,4700,4701,4702,4703,4704,4705,4706,4707,4708,4709,4710,4711,4712,4713,4714,4715,4716,4796,4799,4828,4829,4830,4831,4832,4833,4834,4835,4836,4837,4838,4839,4840,4841,4842,4843,4844,4845,4846,4847,4848,4849,4850,4851,4852,4853,4854,4856,4857,4858,4859,4860,4861,4862,4863,4864,4865,4866,4867,4868,4869,4870,4871,4872,4873,4874,4875,4876,4877,4878,4879,4880,4881,4883,4884,4885,4886,4888,4889,4890,4891,4892,4893,4894,4895,4896,4897,4898,4899,4900,4901,4902,4903,4937,4938,4939,4940,4941,4942,4943,4944,4945,4946,4947,4948,4949,4950,4951,4952,4953,4954,4980,4981,4982,4983,4984,4985,4988,4989,4990,4991,4992,4993,4994,4995,4996,4997,4998,4999,5000,5001,5002,5003,5004,5005,5006,5057,5058,5059,5060,5061,5062,5063,5064,5065,5066,5067,5068,5069,5070,5071,5072,5073,5256,5257,5258,5259,5260,5261,5262,5263,5264,5265,5266,5267,5268,5269,5270,5271,5272,5273,5274,7120,7121,7122,7123,7124,7125,17232,17236,17237,17238,17241,17244,17315,17316,17317,17318,17319,17493';
SET @jakarta = '6608,6609,6610,6611,6612,6613,6615,6616,6617,6618,6619,6620,6621,6622,6623,6624,6626,6627,6628,6629,6630,6631,6632,6633,6634,6635,6637,6638,6639,6640,6641,6642,6643,6644,6646,6647,6648,6649,6650,6651,6652,6653';
SET @bodetabek = '6190,6191,6192,6193,6194,6195,6196,6197,6198,6199,6200,6201,6202,6203,6204,6205,6206,6207,6208,6209,6210,6211,6212,6213,6214,6215,6216,6217,6218,6219,6220,6221,6222,6223,6224,6225,6226,6227,6228,6229,6339,6340,6341,6342,6343,6344,17389,6322,6323,6324,6325,6326,6327,17384,17385,6857,6858,6859,6860,6861,6862,6863,6864,6865,6866,6867,6868,6869,6870,6871,6872,6873,6874,6875,6876,6877,6878,6879,6880,6881,6882,6883,6884,6885,6981,6982,6983,6984,6985,6986,6987,6989,6990,6991,6992,6993,6994,6995,6996,6997,6998,6999,7000,7001,17393,6231,6232,6233,6234,6235,6236,6237,6238,6239,6240,6241,6242,6243,6244,6245,6246,6247,6248,6249,6250,6251,6252,6253,6346,6347,6348,6349,6350,6351,6352,6353,6354,6355,6356,6357,17381,17390';

SELECT 
	id_region,
    region,
    id_city,
    city,
    zone_type,
    SUM(paid_price) 'nmv',
    COUNT(DISTINCT id_sales_order) 'count_so',
    COUNT(id_sales_order_item) 'count_soi'
FROM
    (SELECT 
        so.id_sales_order,
            soi.id_sales_order_item,
            soi.bob_id_sales_order_item,
            soi.paid_price,
            soi.shipping_amount,
            soi.shipping_surcharge,
            soi.paid_price + soi.shipping_amount + soi.shipping_surcharge 'nmv',
            dst.id_customer_address_region 'id_district',
            dst.name 'district',
            cty.id_customer_address_region 'id_city',
            cty.name 'city',
            reg.id_customer_address_region 'id_region',
            reg.name 'region',
            CASE
                WHEN FIND_IN_SET(dst.id_customer_address_region, @jakarta) THEN 'jakarta'
                WHEN FIND_IN_SET(dst.id_customer_address_region, @bodetabek) THEN 'bodetabek'
                WHEN FIND_IN_SET(soa.fk_customer_address_region, @old_free) THEN 'old_free'
                WHEN FIND_IN_SET(soa.fk_customer_address_region, @old_mixed) THEN 'old_mixed'
                WHEN FIND_IN_SET(soa.fk_customer_address_region, @new_free) THEN 'new_free'
                WHEN FIND_IN_SET(soa.fk_customer_address_region, @free) THEN 'other_free_cities'
                ELSE 'paid'
            END 'zone_type'
    FROM
        oms_live.ims_sales_order so
    LEFT JOIN oms_live.ims_sales_order_item soi ON so.id_sales_order = soi.fk_sales_order
    LEFT JOIN oms_live.ims_sales_order_item_status_history soish ON soi.id_sales_order_item = soish.fk_sales_order_item
        AND soish.fk_sales_order_item_status = 67
    LEFT JOIN oms_live.ims_sales_order_address soa ON so.fk_sales_order_address_shipping = soa.id_sales_order_address
    LEFT JOIN oms_live.ims_customer_address_region dst ON soa.fk_customer_address_region = dst.id_customer_address_region
    LEFT JOIN oms_live.ims_customer_address_region cty ON dst.fk_customer_address_region = cty.id_customer_address_region
    LEFT JOIN oms_live.ims_customer_address_region reg ON cty.fk_customer_address_region = reg.id_customer_address_region
    LEFT JOIN bob_live.supplier sup ON soi.bob_id_supplier = sup.id_supplier
    LEFT JOIN screport.seller sel ON sup.id_supplier = sel.src_id
    WHERE
        so.created_at >= @extractstart
            AND so.created_at < @extractend
            AND soish.id_sales_order_item_status_history IS NOT NULL
    GROUP BY soi.id_sales_order_item) result
GROUP BY id_city