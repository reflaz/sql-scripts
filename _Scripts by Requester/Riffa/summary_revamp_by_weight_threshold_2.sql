SET @all_dist = '7103,7102,7101,7100,7099,7098,7097,7064,7063,7062,17353,7061,7060,6703,6702,6701,6700,6699,6698,6697,6696,6695,6694,6693,6692,6691,6690,6689,6688,6687,6686,6033,6032,6031,6030,6029,6028,6027,6026,6025,6024,6023,6022,6021,17376,6020,6019,6018,6017,6016,6015,6014,6013,6012,6011,6010,6009,6008,6007,6006,6005,6004,6003,5786,5785,5784,5783,5782,5781,5780,5779,5778,5777,5776,5775,5774,5773,5772,5771,5770,5769,5768,5767,5766,5765,5764,5763,5762,5761,5760,5759,5758,5757,5756,5755,5754,5753,5752,5751,5750,5749,5748,5683,5682,5681,5680,5679,5678,5677,5676,5675,5674,5673,5672,5671,17501,5670,5669,5668,17502,5667,5666,5665,5664,5663,5662,5661,5660,5659,5658,5657,5382,5381,5380,5379,5378,5377,5376,5375,5374,5373,5372,5371,5370,5369,5368,5367,5366,17494,5365,5364,5363,5362,4935,4934,4933,4932,4931,4930,4929,17242,4928,4927,4926,4925,4924,4923,4922,4921,4920,4919,4918,4917,4916,4915,4914,4913,4912,4911,4910,4909,4908,4907,4906,4905,4735,4734,4733,4732,4731,4730,4729,4728,4727,4726,17240,4725,4724,4723,4722,4721,4720,4719,4718,5130,5129,5128,5126,17249,5125,5124,5116,5115,5113,5112,17247,5111,5109,17245,17246,5108,5107,3704,3703,3702,3701,3700,3699,3698,3697,3696,3695,3694,3693,3692,3691,3690,3689,3688,1746,1745,1744,1743,1742,1741,1740,1739,1738,1737,1736,1735,1734,1733,1732,17483,1731,1730,1729,1669,1667,1666,1665,1664,1663,17480,1662,1668,1661,1660,1659,1658,1657,1656,5073,17244,5072,5071,5070,5069,5068,5067,5066,5065,5064,5063,5062,5061,5060,5059,5058,5057,5006,5005,5004,5003,5002,5001,5000,4999,4998,4997,4996,4995,4994,4993,4992,4991,4990,4989,4988,4985,4984,4983,4982,4981,4980,4903,4902,4901,4900,4899,4898,4897,4896,4895,4894,4893,4892,4891,4890,4889,4888,4886,4885,4884,4883,4811,4810,17241,4799,4796,4716,4715,4714,4712,4711,4710,4709,4708,4707,4706,4705,4704,4703,4702,4701,4700,4699,4698,4697,4648,4647,4646,4645,4644,17236,4643,4642,4641,4639,17237,4638,4637,4636,4635,4634,4633,4631,4630,4629,4627,4626,4625,4598,4590,17235,4576,4575,4574,4573,4572,4571,4570,4569,4567,4566,4565,4564,4563,4495,4494,4493,4492,4491,4490,4489,4488,4487,4485,4484,4483,4481,4480,4478,4477,4476,4475,4474,4473,4472,4471,17232,4470,4469,4468,4467,4466,4465,4464,4463,4462,4460,4459,4458,4457,4456,4455,4454,4453,4452,4451,4450,4449,4448,4446,4445,4444,4442,3945,17629,3944,3943,3942,3941,3940,183,6721,6720,6719,6718,6717,6716,6715,6714,6713,6712,6711,6710,6709,6708,6707,6706,6705,6684,6683,6682,6681,6680,6679,6678,6677,6676,6675,6674,6673,6117,6116,6115,6114,6113,17379,17380,6112,6111,6110,6109,6108,6107,6106,6105,6104,6103,6102,6101,6100,6099,6098,6097,6096,6095,6094,6093,6092,6091,6090,6089,6088,6087,6086,6085,6084,6083,6082,6081,6080,6079,6078,6001,6000,5999,5998,5997,5996,5995,5994,5993,5992,17375,5991,5990,5989,5988,5987,5986,5985,5984,5983,5982,5981,5980,5979,5978,5977,5976,5975,5974,5973,5972,5861,5860,5859,5858,5857,5856,5855,5854,5853,5852,5851,5850,5849,5848,5847,5846,5845,5844,5843,5842,5841,5840,5839,5838,5837,5836,5835,5834,5833,5832,5831,5830,5829,5828,5827,5826,5825,5824,5823,5822,5821,5820,5819,5818,5817,5816,5815,17386,17387,6333,6332,6331,6330,6329,6320,6319,6318,6317,6316,6315,6314,6312,6311,6310,6309,6308,6307,6306,6305,6304,17383,6303,2072,2071,2070,17229,2069,2068,2067,2066,2065,2064,2063,2062,2061,981,980,979,978,977,976,975,17347,974,973,972,971,790,789,788,787,786,785,784,783,782,781,17370,780,779,778,777,776,775,1845,1844,1843,1842,1841,1840,1839,1838,1837,1836,1835,1834,1833,1832,17259,3955,3954,3953,3952,3951';
SET @full_paid = '7103,7102,7101,7100,7099,7098,7097,7064,7063,7062,17353,7061,7060,6703,6702,6701,6700,6699,6698,6697,6696,6695,6694,6693,6692,6691,6690,6689,6688,6687,6686,6033,6032,6031,6030,6029,6028,6027,6026,6025,6024,6023,6022,6021,17376,6020,6019,6018,6017,6016,6015,6014,6013,6012,6011,6010,6009,6008,6007,6006,6005,6004,6003,5786,5785,5784,5783,5782,5781,5780,5779,5778,5777,5776,5775,5774,5773,5772,5771,5770,5769,5768,5767,5766,5765,5764,5763,5762,5761,5760,5759,5758,5757,5756,5755,5754,5753,5752,5751,5750,5749,5748,5683,5682,5681,5680,5679,5678,5677,5676,5675,5674,5673,5672,5671,17501,5670,5669,5668,17502,5667,5666,5665,5664,5663,5662,5661,5660,5659,5658,5657,5382,5381,5380,5379,5378,5377,5376,5375,5374,5373,5372,5371,5370,5369,5368,5367,5366,17494,5365,5364,5363,5362,4935,4934,4933,4932,4931,4930,4929,17242,4928,4927,4926,4925,4924,4923,4922,4921,4920,4919,4918,4917,4916,4915,4914,4913,4912,4911,4910,4909,4908,4907,4906,4905,4735,4734,4733,4732,4731,4730,4729,4728,4727,4726,17240,4725,4724,4723,4722,4721,4720,4719,4718,5130,5129,5128,5126,17249,5125,5124,5116,5115,5113,5112,17247,5111,5109,17245,17246,5108,5107,3704,3703,3702,3701,3700,3699,3698,3697,3696,3695,3694,3693,3692,3691,3690,3689,3688,1746,1745,1744,1743,1742,1741,1740,1739,1738,1737,1736,1735,1734,1733,1732,17483,1731,1730,1729,1669,1667,1666,1665,1664,1663,17480,1662,1668,1661,1660,1659,1658,1657,1656,5073,17244,5072,5071,5070,5069,5068,5067,5066,5065,5064,5063,5062,5061,5060,5059,5058,5057,5006,5005,5004,5003,5002,5001,5000,4999,4998,4997,4996,4995,4994,4993,4992,4991,4990,4989,4988,4985,4984,4983,4982,4981,4980,4903,4902,4901,4900,4899,4898,4897,4896,4895,4894,4893,4892,4891,4890,4889,4888,4886,4885,4884,4883,4811,4810,17241,4799,4796,4716,4715,4714,4712,4711,4710,4709,4708,4707,4706,4705,4704,4703,4702,4701,4700,4699,4698,4697,4648,4647,4646,4645,4644,17236,4643,4642,4641,4639,17237,4638,4637,4636,4635,4634,4633,4631,4630,4629,4627,4626,4625,4598,4590,17235,4576,4575,4574,4573,4572,4571,4570,4569,4567,4566,4565,4564,4563,4495,4494,4493,4492,4491,4490,4489,4488,4487,4485,4484,4483,4481,4480,4478,4477,4476,4475,4474,4473,4472,4471,17232,4470,4469,4468,4467,4466,4465,4464,4463,4462,4460,4459,4458,4457,4456,4455,4454,4453,4452,4451,4450,4449,4448,4446,4445,4444,4442,3945,17629,3944,3943,3942,3941,3940,183';
SET @half_paid = '6721,6720,6719,6718,6717,6716,6715,6714,6713,6712,6711,6710,6709,6708,6707,6706,6705,6684,6683,6682,6681,6680,6679,6678,6677,6676,6675,6674,6673,6117,6116,6115,6114,6113,17379,17380,6112,6111,6110,6109,6108,6107,6106,6105,6104,6103,6102,6101,6100,6099,6098,6097,6096,6095,6094,6093,6092,6091,6090,6089,6088,6087,6086,6085,6084,6083,6082,6081,6080,6079,6078,6001,6000,5999,5998,5997,5996,5995,5994,5993,5992,17375,5991,5990,5989,5988,5987,5986,5985,5984,5983,5982,5981,5980,5979,5978,5977,5976,5975,5974,5973,5972,5861,5860,5859,5858,5857,5856,5855,5854,5853,5852,5851,5850,5849,5848,5847,5846,5845,5844,5843,5842,5841,5840,5839,5838,5837,5836,5835,5834,5833,5832,5831,5830,5829,5828,5827,5826,5825,5824,5823,5822,5821,5820,5819,5818,5817,5816,5815,17386,17387,6333,6332,6331,6330,6329,6320,6319,6318,6317,6316,6315,6314,6312,6311,6310,6309,6308,6307,6306,6305,6304,17383,6303,2072,2071,2070,17229,2069,2068,2067,2066,2065,2064,2063,2062,2061,981,980,979,978,977,976,975,17347,974,973,972,971,790,789,788,787,786,785,784,783,782,781,17370,780,779,778,777,776,775,1845,1844,1843,1842,1841,1840,1839,1838,1837,1836,1835,1834,1833,1832,17259,3955,3954,3953,3952,3951';

SELECT 
	city,
    zone_type,
    COUNT(DISTINCT id_sales_order) 'count_so',
    COUNT(bob_id_sales_order_item) 'count_soi',
    SUM(unit_price) 'total_unit_price',
    SUM(paid_price) 'total_paid_price',
    SUM(shipping_charge) 'total_shipping_charge',
    SUM(rounded_weight) 'total_rounded_weight'
FROM
    (SELECT 
        city,
			zone_type,
			id_sales_order,
            bob_id_sales_order_item,
            unit_price,
            paid_price,
            shipping_charge,
            formula_weight,
            CEIL(formula_weight) 'rounded_weight'
    FROM
        (SELECT 
        so.id_sales_order,
            city,
            zone_type,
            soi.bob_id_sales_order_item,
            soi.unit_price,
            soi.paid_price,
            soi.shipping_amount + soi.shipping_surcharge 'shipping_charge',
            so.fk_customer_address_region,
            GREATEST(IFNULL(CASE
                WHEN
                    cspu.weight > 0
                        OR (cspu.length * cspu.width * cspu.height) > 0
                THEN
                    cspu.weight
                ELSE cc.package_weight
            END, 0), IFNULL(CASE
                WHEN
                    cspu.weight > 0
                        OR (cspu.length * cspu.width * cspu.height) > 0
                THEN
                    (cspu.length * cspu.width * cspu.height) / 6000
                ELSE cc.package_length * cc.package_width * cc.package_height / 6000
            END, 0)) 'formula_weight',
            CASE
                WHEN soish.created_at IS NULL THEN 0
                WHEN sel.tax_class = 1 THEN 0
                WHEN soi.delivery_type = 'digital' THEN 0
                WHEN sp.shipment_provider_name = 'Digital Delivery' THEN 0
                ELSE 1
            END 'pass'
    FROM
        (SELECT 
        so.id_sales_order,
            city.name 'city',
            soa.fk_customer_address_region,
            CASE
				WHEN FIND_IN_SET(soa.fk_customer_address_region, @full_paid) THEN 'Paid full price'
                WHEN FIND_IN_SET(soa.fk_customer_address_region, @half_paid) THEN 'Paid half price'
            END 'zone_type'
    FROM
        oms_live.ims_sales_order so
    LEFT JOIN oms_live.ims_sales_order_address soa ON so.fk_sales_order_address_shipping = soa.id_sales_order_address
    LEFT JOIN oms_live.ims_customer_address_region dist ON soa.fk_customer_address_region = dist.id_customer_address_region
    LEFT JOIN oms_live.ims_customer_address_region city ON dist.fk_customer_address_region = city.id_customer_address_region
    WHERE
        so.created_at >= '2016-10-01'
            AND so.created_at < '2016-11-01'
            AND FIND_IN_SET(soa.fk_customer_address_region, @all_dist)) so
    LEFT JOIN oms_live.ims_sales_order_item soi ON so.id_sales_order = soi.fk_sales_order
    LEFT JOIN oms_live.ims_sales_order_item_status_history soish ON soi.id_sales_order_item = soish.fk_sales_order_item
        AND soish.fk_sales_order_item_status = 67
    LEFT JOIN oms_live.oms_package_item pi ON soi.id_sales_order_item = pi.fk_sales_order_item
    LEFT JOIN oms_live.oms_package pck ON pi.fk_package = pck.id_package
    LEFT JOIN oms_live.oms_package_dispatching pd ON pck.id_package = pd.fk_package
    LEFT JOIN oms_live.oms_shipment_provider sp ON pd.fk_shipment_provider = sp.id_shipment_provider
    LEFT JOIN bob_live.catalog_simple cs ON soi.sku = cs.sku
    LEFT JOIN bob_live.catalog_config cc ON cc.id_catalog_config = cs.fk_catalog_config
    LEFT JOIN bob_live.catalog_simple_package_unit cspu ON cs.id_catalog_simple = cspu.fk_catalog_simple
    LEFT JOIN bob_live.supplier sup ON soi.bob_id_supplier = sup.id_supplier
    LEFT JOIN asc_live.seller sel ON sup.id_supplier = sel.src_id
    GROUP BY bob_id_sales_order_item
    HAVING pass = 1) result) result
GROUP BY city